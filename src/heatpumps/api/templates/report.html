{% extends "base.html" %}

{% block content %}

{# param_descriptions is now passed from the Python backend via parameter_descriptions.py #}

<!-- Configuration Results - 4-column metrics -->
{% if report_data.configuration_results %}
<section class="results-section">
    <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">Configuration Results</h2>

    <div class="metrics-grid">
        {% if report_data.configuration_results.cop is not none %}
        <div class="metric-card">
            <div class="metric-label">COP</div>
            <div class="metric-value">{{ "%.2f"|format(report_data.configuration_results.cop) }}</div>
        </div>
        {% endif %}

        {% if report_data.configuration_results.heat_output_w is not none %}
        <div class="metric-card">
            <div class="metric-label">Q̇<sub>ab</sub> (W)</div>
            <div class="metric-value">{{ "{:,.0f}".format(report_data.configuration_results.heat_output_w) }}</div>
        </div>
        {% endif %}

        {% if report_data.configuration_results.power_input_w is not none %}
        <div class="metric-card">
            <div class="metric-label">P<sub>zu</sub> (W)</div>
            <div class="metric-value">{{ "{:,.0f}".format(report_data.configuration_results.power_input_w) }}</div>
        </div>
        {% endif %}

        {% if report_data.configuration_results.heat_input_w is not none %}
        <div class="metric-card">
            <div class="metric-label">Q̇<sub>zu</sub> (W)</div>
            <div class="metric-value">{{ "{:,.0f}".format(report_data.configuration_results.heat_input_w) }}</div>
        </div>
        {% endif %}
    </div>
</section>
{% endif %}

<!-- Analysis Data - For MCP-generated reports with rich analysis -->
{% if report_data.analysis_data %}
<div class="expander open">
    <div class="expander-header">
        <span>Analysis Results</span>
        <span class="expander-icon">▼</span>
    </div>
    <div class="expander-content">
        {% set ad = report_data.analysis_data %}

        {# Scenario Description #}
        {% if ad.get('scenario') or ad.get('topology_recommendation') or ad.get('refrigerant_recommendation') %}
        <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
            {% if ad.get('scenario') %}
            <h3 style="margin-bottom: 0.5rem;">{{ ad.get('scenario') }}</h3>
            {% endif %}
            {% if ad.get('topology_recommendation') %}
            <p style="margin-bottom: 0.25rem;"><strong>Topology:</strong> {{ ad.get('topology_recommendation') }}</p>
            {% endif %}
            {% if ad.get('refrigerant_recommendation') %}
            <p><strong>Refrigerant:</strong> {{ ad.get('refrigerant_recommendation') }}</p>
            {% endif %}
        </div>
        {% endif %}

        {# Performance Metrics Grid #}
        <h3 style="margin-bottom: 1rem;">Performance Metrics</h3>
        <div class="metrics-grid" style="margin-bottom: 1.5rem;">
            {% if ad.get('cooling_capacity_kw') is not none %}
            <div class="metric-card">
                <div class="metric-label">Cooling Capacity</div>
                <div class="metric-value">{{ "{:,.0f}".format(ad.get('cooling_capacity_kw')) }} kW</div>
            </div>
            {% endif %}

            {% if ad.get('cop_average') is not none %}
            <div class="metric-card">
                <div class="metric-label">Average COP</div>
                <div class="metric-value">{{ "%.2f"|format(ad.get('cop_average')) }}</div>
            </div>
            {% elif ad.get('cop_summer') is not none %}
            <div class="metric-card">
                <div class="metric-label">COP (Summer)</div>
                <div class="metric-value">{{ "%.2f"|format(ad.get('cop_summer')) }}</div>
            </div>
            {% endif %}

            {% if ad.get('pue_annual_average') is not none %}
            <div class="metric-card">
                <div class="metric-label">Annual PUE</div>
                <div class="metric-value">{{ "%.2f"|format(ad.get('pue_annual_average')) }}</div>
            </div>
            {% endif %}

            {% if ad.get('annual_electricity_mwh') is not none %}
            <div class="metric-card">
                <div class="metric-label">Annual Electricity</div>
                <div class="metric-value">{{ "{:,.0f}".format(ad.get('annual_electricity_mwh')) }} MWh</div>
            </div>
            {% endif %}
        </div>

        {# Operating Conditions Table #}
        {% if ad.get('dc_water_inlet_temp_c') is not none or ad.get('wetland_temp_summer_c') is not none %}
        <h3 style="margin-bottom: 0.5rem;">Operating Conditions</h3>
        <table class="data-table" style="margin-bottom: 1.5rem;">
            <thead>
                <tr>
                    <th>Parameter</th>
                    <th>Summer</th>
                    <th>Winter</th>
                </tr>
            </thead>
            <tbody>
                {% if ad.get('dc_water_inlet_temp_c') is not none %}
                <tr>
                    <td>Data Centre Water Inlet</td>
                    <td colspan="2">{{ ad.get('dc_water_inlet_temp_c') }}°C</td>
                </tr>
                {% endif %}
                {% if ad.get('dc_water_outlet_temp_c') is not none %}
                <tr>
                    <td>Data Centre Water Outlet</td>
                    <td colspan="2">{{ ad.get('dc_water_outlet_temp_c') }}°C</td>
                </tr>
                {% endif %}
                {% if ad.get('wetland_temp_summer_c') is not none or ad.get('wetland_temp_winter_c') is not none %}
                <tr>
                    <td>Wetland Temperature</td>
                    <td>{{ ad.get('wetland_temp_summer_c') }}°C</td>
                    <td>{{ ad.get('wetland_temp_winter_c') }}°C</td>
                </tr>
                {% endif %}
                {% if ad.get('condenser_outlet_summer_c') is not none or ad.get('condenser_outlet_winter_c') is not none %}
                <tr>
                    <td>Condenser Outlet</td>
                    <td>{{ ad.get('condenser_outlet_summer_c') }}°C</td>
                    <td>{{ ad.get('condenser_outlet_winter_c') }}°C</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
        {% endif %}

        {# Seasonal Performance Table #}
        {% if ad.get('cop_summer') is not none or ad.get('power_input_summer_kw') is not none %}
        <h3 style="margin-bottom: 0.5rem;">Seasonal Performance</h3>
        <table class="data-table" style="margin-bottom: 1.5rem;">
            <thead>
                <tr>
                    <th>Parameter</th>
                    <th>Summer</th>
                    <th>Winter</th>
                </tr>
            </thead>
            <tbody>
                {% if ad.get('cop_summer') is not none or ad.get('cop_winter') is not none %}
                <tr>
                    <td>COP</td>
                    <td>{{ "%.2f"|format(ad.get('cop_summer')) if ad.get('cop_summer') is not none else 'N/A' }}</td>
                    <td>{{ "%.2f"|format(ad.get('cop_winter')) if ad.get('cop_winter') is not none else 'N/A' }}</td>
                </tr>
                {% endif %}
                {% if ad.get('power_input_summer_kw') is not none or ad.get('power_input_winter_kw') is not none %}
                <tr>
                    <td>Power Input (kW)</td>
                    <td>{{ "{:,.1f}".format(ad.get('power_input_summer_kw')) if ad.get('power_input_summer_kw') is not none else 'N/A' }}</td>
                    <td>{{ "{:,.1f}".format(ad.get('power_input_winter_kw')) if ad.get('power_input_winter_kw') is not none else 'N/A' }}</td>
                </tr>
                {% endif %}
                {% if ad.get('heat_rejected_summer_kw') is not none or ad.get('heat_rejected_winter_kw') is not none %}
                <tr>
                    <td>Heat Rejected (kW)</td>
                    <td>{{ "{:,.1f}".format(ad.get('heat_rejected_summer_kw')) if ad.get('heat_rejected_summer_kw') is not none else 'N/A' }}</td>
                    <td>{{ "{:,.1f}".format(ad.get('heat_rejected_winter_kw')) if ad.get('heat_rejected_winter_kw') is not none else 'N/A' }}</td>
                </tr>
                {% endif %}
                {% if ad.get('pue_chiller') is not none or ad.get('pue_free_cooling') is not none %}
                <tr>
                    <td>PUE</td>
                    <td>{{ "%.2f"|format(ad.get('pue_chiller')) if ad.get('pue_chiller') is not none else 'N/A' }} (chiller)</td>
                    <td>{{ "%.2f"|format(ad.get('pue_free_cooling')) if ad.get('pue_free_cooling') is not none else 'N/A' }} (free cooling)</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
        {% endif %}

        {# Operating Hours #}
        {% if ad.get('free_cooling_hours') is not none or ad.get('chiller_hours') is not none %}
        <h3 style="margin-bottom: 0.5rem;">Annual Operating Hours</h3>
        <div class="metrics-grid" style="margin-bottom: 1.5rem;">
            {% if ad.get('free_cooling_hours') is not none %}
            <div class="metric-card">
                <div class="metric-label">Free Cooling</div>
                <div class="metric-value">{{ "{:,}".format(ad.get('free_cooling_hours')) }} hrs</div>
            </div>
            {% endif %}
            {% if ad.get('chiller_hours') is not none %}
            <div class="metric-card">
                <div class="metric-label">Chiller Operation</div>
                <div class="metric-value">{{ "{:,}".format(ad.get('chiller_hours')) }} hrs</div>
            </div>
            {% endif %}
            {% if ad.get('backup_hours') is not none %}
            <div class="metric-card">
                <div class="metric-label">Backup</div>
                <div class="metric-value">{{ "{:,}".format(ad.get('backup_hours')) }} hrs</div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {# Heat Recovery #}
        {% if ad.get('heat_recovery_potential_kw') is not none or ad.get('heat_recovery_annual_mwh') is not none %}
        <h3 style="margin-bottom: 0.5rem;">Heat Recovery Potential</h3>
        <div class="metrics-grid" style="margin-bottom: 1.5rem;">
            {% if ad.get('heat_recovery_potential_kw') is not none %}
            <div class="metric-card">
                <div class="metric-label">Capacity</div>
                <div class="metric-value">{{ "{:,.0f}".format(ad.get('heat_recovery_potential_kw')) }} kW</div>
            </div>
            {% endif %}
            {% if ad.get('heat_recovery_annual_mwh') is not none %}
            <div class="metric-card">
                <div class="metric-label">Annual Energy</div>
                <div class="metric-value">{{ "{:,.0f}".format(ad.get('heat_recovery_annual_mwh')) }} MWh</div>
            </div>
            {% endif %}
            {% if ad.get('heat_recovery_revenue_gbp') is not none %}
            <div class="metric-card">
                <div class="metric-label">Annual Revenue</div>
                <div class="metric-value">£{{ "{:,.0f}".format(ad.get('heat_recovery_revenue_gbp')) }}</div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {# Annual Summary #}
        {% if ad.get('annual_cooling_mwh') is not none %}
        <h3 style="margin-bottom: 0.5rem;">Annual Summary</h3>
        <div class="metrics-grid">
            {% if ad.get('annual_cooling_mwh') is not none %}
            <div class="metric-card">
                <div class="metric-label">Annual Cooling</div>
                <div class="metric-value">{{ "{:,.0f}".format(ad.get('annual_cooling_mwh')) }} MWh</div>
            </div>
            {% endif %}
            {% if ad.get('annual_electricity_mwh') is not none %}
            <div class="metric-card">
                <div class="metric-label">Electricity Consumption</div>
                <div class="metric-value">{{ "{:,.0f}".format(ad.get('annual_electricity_mwh')) }} MWh</div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Input Parameters - Expander -->
{% if report_data.parameters %}
<div class="expander">
    <div class="expander-header">
        <span>Input Parameters</span>
        <span class="expander-icon">▼</span>
    </div>
    <div class="expander-content">
        {# Group parameters by category #}
        {% set param_groups = {
            'Operating Conditions': ['ambient', 'T_hs_ff', 'T_cons_ff', 'Q_N'],
            'Heat Source (B)': ['B1', 'B2', 'B3'],
            'Consumer (C)': ['C0', 'C1', 'C2', 'C3'],
            'Refrigerant Circuit (A)': ['A0', 'A1', 'A2', 'A3', 'A4', 'A5'],
            'Components': ['comp', 'cond', 'eva', 'ihx', 'valve'],
            'System Setup': ['setup', 'offdesign']
        } %}

        {% for section_name, section_data in report_data.parameters.items() %}
        {% if section_data is mapping %}
        <div style="margin-bottom: 1.5rem;">
            <h3 style="margin-bottom: 0.5rem; text-transform: capitalize;">
                {# Format section name nicely #}
                {% if section_name == 'ambient' %}Ambient Conditions
                {% elif section_name == 'setup' %}System Setup
                {% elif section_name == 'comp' %}Compressor
                {% elif section_name == 'cond' %}Condenser
                {% elif section_name == 'eva' %}Evaporator
                {% elif section_name == 'ihx' %}Internal Heat Exchanger
                {% elif section_name == 'offdesign' %}Off-Design Configuration
                {% elif section_name.startswith('A') %}Refrigerant Point {{ section_name }}
                {% elif section_name.startswith('B') %}Heat Source Point {{ section_name }}
                {% elif section_name.startswith('C') %}Consumer Point {{ section_name }}
                {% else %}{{ section_name.replace('_', ' ') }}
                {% endif %}
            </h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                        <th>Unit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for param_name, param_value in section_data.items() %}
                    {% if param_value is not mapping and param_value is not none %}
                    <tr>
                        <td>
                            {# Format parameter names nicely #}
                            {% if param_name == 'T' %}Temperature
                            {% elif param_name == 'p' %}Pressure
                            {% elif param_name == 'm' %}Mass Flow Rate
                            {% elif param_name == 'Q' %}Heat Transfer
                            {% elif param_name == 'eta_s' %}Isentropic Efficiency
                            {% elif param_name == 'eta_s_char' %}Efficiency Characteristic
                            {% elif param_name == 'pr' %}Pressure Ratio
                            {% elif param_name == 'ttd_u' %}Upper Terminal Temp. Diff.
                            {% elif param_name == 'ttd_l' %}Lower Terminal Temp. Diff.
                            {% elif param_name == 'refrig' %}Refrigerant
                            {% elif param_name == 'type' %}Model Type
                            {% elif param_name == 'name' %}Model Name
                            {% else %}{{ param_name.replace('_', ' ').title() }}
                            {% endif %}
                        </td>
                        <td>
                            {% if param_value is number %}
                                {{ "%.4g"|format(param_value) }}
                            {% elif param_value is string %}
                                {{ param_value }}
                            {% elif param_value == true %}
                                Yes
                            {% elif param_value == false %}
                                No
                            {% else %}
                                {{ param_value }}
                            {% endif %}
                        </td>
                        <td style="color: var(--text-secondary); font-size: 0.875rem;">
                            {# Add units based on parameter name #}
                            {% if param_name == 'T' %}°C
                            {% elif param_name == 'p' %}bar
                            {% elif param_name == 'm' %}kg/s
                            {% elif param_name == 'Q' or param_name == 'Q_N' %}W
                            {% elif param_name == 'eta_s' %}%
                            {% elif param_name == 'ttd_u' or param_name == 'ttd_l' %}K
                            {% elif param_name == 'pr' %}-
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Topology & Refrigerant - Expander -->
{% if report_data.topology_refrigerant %}
<div class="expander">
    <div class="expander-header">
        <span>Topology & Refrigerant</span>
        <span class="expander-icon">▼</span>
    </div>
    <div class="expander-content">
        <div class="two-column-grid">
            <!-- Topology SVG -->
            <div class="svg-container">
                <h3 style="margin-bottom: 1rem;">Heat Pump Topology</h3>
                <p style="color: var(--text-secondary);">
                    Model: <strong>{{ report_data.topology_refrigerant.model_type }}</strong>
                </p>
                {% if report_data.metadata.model_name %}
                <img src="/static/img/topologies/hp_{{ report_data.metadata.model_name }}_label.svg"
                     alt="Heat Pump Topology"
                     style="max-width: 100%; height: auto; background: white; padding: 1rem; border-radius: 8px;"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <p style="display: none; color: var(--text-secondary); font-style: italic;">Topology diagram not available for this model</p>
                {% else %}
                <p style="color: var(--text-secondary); font-style: italic;">Topology diagram not available</p>
                {% endif %}
            </div>

            <!-- Refrigerant Properties -->
            <div>
                <h3 style="margin-bottom: 1rem;">Refrigerant Properties</h3>
                {% if report_data.topology_refrigerant.refrigerant %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Property</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Refrigerant</td>
                            <td><strong>{{ report_data.topology_refrigerant.refrigerant }}</strong></td>
                        </tr>
                        {% if refrigerants and report_data.topology_refrigerant.refrigerant in refrigerants %}
                        {% set ref_data = refrigerants[report_data.topology_refrigerant.refrigerant] %}
                        <tr>
                            <td>Type</td>
                            <td>{{ ref_data.Type if ref_data.Type else 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td>T<sub>NBP</sub> (°C)</td>
                            <td>{{ "%.2f"|format(ref_data.T_NBP) if ref_data.T_NBP is not none else 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td>T<sub>crit</sub> (°C)</td>
                            <td>{{ "%.2f"|format(ref_data.T_crit) if ref_data.T_crit is not none else 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td>p<sub>crit</sub> (bar)</td>
                            <td>{{ "%.2f"|format(ref_data.p_crit) if ref_data.p_crit is not none else 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td>ASHRAE 34</td>
                            <td>{{ ref_data.ASHRAE34 if ref_data.ASHRAE34 else 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td>ODP</td>
                            <td>{{ "%.3f"|format(ref_data.ODP) if ref_data.ODP is not none else 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td>GWP<sub>100</sub></td>
                            <td>{{ "{:,.0f}".format(ref_data.GWP100) if ref_data.GWP100 is not none else 'N/A' }}</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
                {% endif %}
                <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">All fabric data and classifications from <a href="http://www.coolprop.org" target="_blank">Coolprop</a> or <a href="https://doi.org/10.1016/J.ENERGY.2018.03.166" target="_blank">Arpagaus et al. (2018)</a></p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- State Variables - Expander -->
{% if report_data.state_variables %}
<div class="expander">
    <div class="expander-header">
        <span>State Variables</span>
        <span class="expander-icon">▼</span>
    </div>
    <div class="expander-content">
        {# Determine which fluids are present #}
        {% set has_refrigerant = namespace(value=false) %}
        {% set has_water = namespace(value=false) %}
        {% set refrigerant_name = report_data.metadata.refrigerant if report_data.metadata else 'Refrigerant' %}
        {% for conn_data in report_data.state_variables.connections %}
            {% if conn_data.get('R717') == 1.0 or conn_data.get('R134a') == 1.0 or conn_data.get('R1234yf') == 1.0 or conn_data.get('R290') == 1.0 %}
                {% set has_refrigerant.value = true %}
            {% endif %}
            {% if conn_data.get('H2O') == 1.0 %}
                {% set has_water.value = true %}
            {% endif %}
        {% endfor %}

        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Point</th>
                        <th>Fluid</th>
                        <th>Phase</th>
                        <th>m (kg/s)</th>
                        <th>p (bar)</th>
                        <th>T (°C)</th>
                        <th>h (kJ/kg)</th>
                        <th>s (J/kgK)</th>
                        <th>x (-)</th>
                        <th>ΔT<sub>sh/sc</sub> (K)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for conn_data in report_data.state_variables.connections %}
                    {% set conn_id = report_data.state_variables.index[loop.index0] if report_data.state_variables.index else loop.index0 %}
                    {# Determine fluid type #}
                    {% set fluid_type = 'Unknown' %}
                    {% if conn_data.get('H2O') == 1.0 %}
                        {% set fluid_type = 'Water' %}
                    {% elif conn_data.get(refrigerant_name) == 1.0 or conn_data.get('R717') == 1.0 or conn_data.get('R134a') == 1.0 %}
                        {% set fluid_type = refrigerant_name %}
                    {% endif %}
                    {# Determine phase from x value #}
                    {% set phase_display = '-' %}
                    {% set phase_color = '' %}
                    {% if conn_data.get('phase') %}
                        {% if conn_data.phase == 'l' %}
                            {% set phase_display = 'Liquid' %}
                            {% set phase_color = 'color: #3b82f6;' %}
                        {% elif conn_data.phase == 'g' %}
                            {% set phase_display = 'Vapor' %}
                            {% set phase_color = 'color: #ef4444;' %}
                        {% elif conn_data.phase == 'tp' %}
                            {% set phase_display = 'Two-Phase' %}
                            {% set phase_color = 'color: #8b5cf6;' %}
                        {% else %}
                            {% set phase_display = conn_data.phase %}
                        {% endif %}
                    {% elif conn_data.x is not none %}
                        {% if conn_data.x == 0 %}
                            {% set phase_display = 'Sat. Liquid' %}
                            {% set phase_color = 'color: #3b82f6;' %}
                        {% elif conn_data.x == 1 %}
                            {% set phase_display = 'Sat. Vapor' %}
                            {% set phase_color = 'color: #ef4444;' %}
                        {% elif conn_data.x > 0 and conn_data.x < 1 %}
                            {% set phase_display = 'Two-Phase' %}
                            {% set phase_color = 'color: #8b5cf6;' %}
                        {% elif conn_data.x < 0 %}
                            {% set phase_display = 'Subcooled' %}
                            {% set phase_color = 'color: #0ea5e9;' %}
                        {% elif conn_data.x > 1 %}
                            {% set phase_display = 'Superheated' %}
                            {% set phase_color = 'color: #f97316;' %}
                        {% endif %}
                    {% endif %}
                    {# Superheat/Subcool from Td_bp #}
                    {% set delta_t = conn_data.get('Td_bp') %}
                    <tr style="{% if fluid_type == 'Water' %}background: rgba(59, 130, 246, 0.05);{% endif %}">
                        <td><strong>{{ conn_id }}</strong></td>
                        <td>{{ fluid_type }}</td>
                        <td style="{{ phase_color }} font-weight: 500;">{{ phase_display }}</td>
                        <td>{{ "%.3f"|format(conn_data.m) if conn_data.m is not none else '-' }}</td>
                        <td>{{ "%.2f"|format(conn_data.p) if conn_data.p is not none else '-' }}</td>
                        <td>{{ "%.1f"|format(conn_data.T) if conn_data.T is not none else '-' }}</td>
                        <td>{{ "%.1f"|format(conn_data.h) if conn_data.h is not none else '-' }}</td>
                        <td>{{ "%.1f"|format(conn_data.s) if conn_data.s is not none else '-' }}</td>
                        <td>{{ "%.3f"|format(conn_data.x) if conn_data.x is not none and conn_data.x >= 0 and conn_data.x <= 1 else '-' }}</td>
                        <td>{{ "%.1f"|format(delta_t) if delta_t is not none and delta_t != 0 else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--text-secondary);">
            <strong>Legend:</strong> x = vapor quality (0=sat. liquid, 1=sat. vapor); ΔT<sub>sh/sc</sub> = superheat (+) or subcooling (-)
        </p>
    </div>
</div>
{% endif %}

<!-- State Diagrams - Expander -->
<div class="expander">
    <div class="expander-header">
        <span>State Diagrams</span>
        <span class="expander-icon">▼</span>
    </div>
    <div class="expander-content">
        {% if diagram_paths and (diagram_paths.get('ph') or diagram_paths.get('ts')) %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 2rem; margin: 1rem 0;">
            {% if diagram_paths.get('ph') %}
            <div class="svg-container">
                <h4 style="margin-bottom: 1rem;">Pressure-Enthalpy (P-h) Diagram</h4>
                <img src="/static/img/{{ diagram_paths.ph }}"
                     alt="P-h Diagram"
                     style="max-width: 100%; height: auto;">
            </div>
            {% endif %}

            {% if diagram_paths.get('ts') %}
            <div class="svg-container">
                <h4 style="margin-bottom: 1rem;">Temperature-Entropy (T-s) Diagram</h4>
                <img src="/static/img/{{ diagram_paths.ts }}"
                     alt="T-s Diagram"
                     style="max-width: 100%; height: auto;">
            </div>
            {% endif %}
        </div>
        {% else %}
        <p style="color: var(--text-secondary); font-style: italic; text-align: center; padding: 2rem;">
            State diagrams are not available for this report.
        </p>
        {% endif %}
    </div>
</div>


<!-- Economic Evaluation - Expander -->
{% if report_data.economic_evaluation %}
<div class="expander">
    <div class="expander-header">
        <span>Economic Evaluation</span>
        <span class="expander-icon">▼</span>
    </div>
    <div class="expander-content">
        {# Get currency settings - default to EUR if not specified #}
        {% set currency_symbol = report_data.economic_evaluation.currency_symbol | default('€') %}
        {% set currency_code = report_data.economic_evaluation.currency_code | default('EUR') %}
        {% set exchange_rate = report_data.economic_evaluation.exchange_rate | default(1.0) %}

        {% if report_data.economic_evaluation %}
        <div class="two-column-grid" style="margin-bottom: 2rem;">
            {# Use converted costs if available, otherwise fall back to EUR values #}
            {% if report_data.economic_evaluation.cost_total is not none %}
            <div class="metric-card">
                <div class="metric-label">Total Investment Cost</div>
                <div class="metric-value" style="font-size: 2rem;">
                    {{ currency_symbol }}{{ "{:,.0f}".format(report_data.economic_evaluation.cost_total) }}
                </div>
            </div>
            {% elif report_data.economic_evaluation.total_cost_eur is not none %}
            <div class="metric-card">
                <div class="metric-label">Total Investment Cost</div>
                <div class="metric-value" style="font-size: 2rem;">
                    {{ currency_symbol }}{{ "{:,.0f}".format(report_data.economic_evaluation.total_cost_eur * exchange_rate) }}
                </div>
            </div>
            {% endif %}

            {% if report_data.economic_evaluation.cost_specific is not none %}
            <div class="metric-card">
                <div class="metric-label">Specific Investment Cost</div>
                <div class="metric-value" style="font-size: 2rem;">
                    {{ currency_symbol }}{{ "{:,.0f}".format(report_data.economic_evaluation.cost_specific) }}/MW
                </div>
            </div>
            {% elif report_data.economic_evaluation.specific_cost_eur_per_mw is not none %}
            <div class="metric-card">
                <div class="metric-label">Specific Investment Cost</div>
                <div class="metric-value" style="font-size: 2rem;">
                    {{ currency_symbol }}{{ "{:,.0f}".format(report_data.economic_evaluation.specific_cost_eur_per_mw * exchange_rate) }}/MW
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if report_data.economic_evaluation.component_costs %}
        <h3 style="margin-top: 1rem; margin-bottom: 0.5rem;">Component Costs</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Component</th>
                    <th>Cost ({{ currency_symbol }})</th>
                </tr>
            </thead>
            <tbody>
                {% for component, cost in report_data.economic_evaluation.component_costs.items() %}
                <tr>
                    <td>{{ component }}</td>
                    <td>{{ "{:,.0f}".format(cost * exchange_rate) if cost is not none else 'N/A' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if currency_code != 'EUR' %}
        <p style="margin-top: 0.5rem; font-size: 0.85rem; color: #888;">
            Costs converted from EUR at rate: 1 EUR = {{ "%.4f"|format(exchange_rate) }} {{ currency_code }}
        </p>
        {% endif %}

        <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">Methodology for the calculation of the costs analogous to <a href="https://doi.org/10.1016/j.enconman.2020.113488" target="_blank">Kosmadakis et al. (2020)</a>, based on <a href="https://www.wiley.com/en-us/Thermal+Design+and+Optimization-p-9780471584674" target="_blank">Bejan et al. (1995)</a>.</p>
    </div>
</div>
{% endif %}

<!-- Exergy Assessment - Expander (default open) -->
{% if report_data.exergy_assessment %}
<div class="expander open">
    <div class="expander-header">
        <span>Exergy Assessment</span>
        <span class="expander-icon">▼</span>
    </div>
    <div class="expander-content">
        {% if report_data.exergy_assessment %}
        <div class="metrics-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
            {% if report_data.exergy_assessment.E_D_w is not none %}
            <div class="metric-card">
                <div class="metric-label">Ė<sub>D,tot</sub> (W)</div>
                <div class="metric-value" style="font-size: 1.75rem;">
                    {{ "{:,.0f}".format(report_data.exergy_assessment.E_D_w) }}
                </div>
            </div>
            {% endif %}

            {% if report_data.exergy_assessment.epsilon is not none %}
            <div class="metric-card">
                <div class="metric-label">η<sub>ex</sub> (%)</div>
                <div class="metric-value" style="font-size: 1.75rem;">
                    {{ "%.2f"|format(report_data.exergy_assessment.epsilon) }}
                </div>
            </div>
            {% endif %}

            {% if report_data.exergy_assessment.E_F_w is not none %}
            <div class="metric-card">
                <div class="metric-label">Ė<sub>F</sub> (W)</div>
                <div class="metric-value" style="font-size: 1.75rem;">
                    {{ "{:,.0f}".format(report_data.exergy_assessment.E_F_w) }}
                </div>
            </div>
            {% endif %}

            {% if report_data.exergy_assessment.E_P_w is not none %}
            <div class="metric-card">
                <div class="metric-label">Ė<sub>P</sub> (W)</div>
                <div class="metric-value" style="font-size: 1.75rem;">
                    {{ "{:,.0f}".format(report_data.exergy_assessment.E_P_w) }}
                </div>
            </div>
            {% endif %}

        </div>
        {% endif %}

        <!-- Sankey Diagram -->
        {% if report_data.exergy_assessment.sankey_data %}
        <div class="plotly-container" id="sankeyDiagram"></div>
        {% endif %}

        <!-- Component Exergy Table - reads from component_data array -->
        {% if report_data.exergy_assessment.component_data %}
        <h3 style="margin-top: 2rem; margin-bottom: 0.5rem;">Component Exergy Analysis</h3>
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Ė<sub>F</sub> (kW)</th>
                        <th>Ė<sub>P</sub> (kW)</th>
                        <th>Ė<sub>D</sub> (kW)</th>
                        <th>ε (%)</th>
                        <th>y<sub>D</sub> (%)</th>
                    </tr>
                </thead>
                <tbody>
                    {% set component_index = report_data.exergy_assessment.component_index %}
                    {% for comp_data in report_data.exergy_assessment.component_data %}
                    {% if comp_data.E_D is not none and comp_data.E_D > 0 %}
                    <tr>
                        <td><strong>{{ component_index[loop.index0] if component_index else loop.index0 }}</strong></td>
                        <td>{{ "{:,.1f}".format(comp_data.E_F / 1000) if comp_data.E_F is not none else '-' }}</td>
                        <td>{{ "{:,.1f}".format(comp_data.E_P / 1000) if comp_data.E_P is not none else '-' }}</td>
                        <td>{{ "{:,.1f}".format(comp_data.E_D / 1000) if comp_data.E_D is not none else '-' }}</td>
                        <td>{{ "%.1f"|format(comp_data.epsilon * 100) if comp_data.epsilon is not none else '-' }}</td>
                        <td>{{ "%.2f"|format(comp_data.y_Dk * 100) if comp_data.y_Dk is not none else '-' }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Waterfall Diagram -->
        {% if diagram_paths and diagram_paths.get('waterfall') %}
        <h3 style="margin-top: 2rem; margin-bottom: 0.5rem;">Exergy Destruction Waterfall</h3>
        <div class="svg-container" style="margin-top: 1rem;">
            <img src="/static/img/{{ diagram_paths.waterfall }}"
                 alt="Exergy Destruction Waterfall"
                 style="max-width: 100%; height: auto;">
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Glossary of Terms - Expander -->
{% if glossary %}
<div class="expander">
    <div class="expander-header">
        <span>G L O S S A R Y &nbsp; O F &nbsp; T E R M S</span>
        <span class="expander-icon">▼</span>
    </div>
    <div class="expander-content">
        <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
            Key terms and definitions used in heat pump simulation and thermodynamic analysis.
        </p>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(450px, 1fr)); gap: 1rem;">
            {% for term, description in glossary.items() %}
            <div style="padding: 0.75rem; background: var(--bg-card); border-radius: 6px; border-left: 3px solid var(--primary);">
                <dt style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">{{ term }}</dt>
                <dd style="margin: 0; color: var(--text-secondary); font-size: 0.9rem; line-height: 1.4;">{{ description }}</dd>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<!-- Render Sankey Diagram if data exists -->
{% if report_data.exergy_assessment and report_data.exergy_assessment.sankey_data %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var sankeyData = {{ report_data.exergy_assessment.sankey_data | tojson }};

        // Plotly expects the data in specific format
        Plotly.newPlot('sankeyDiagram', sankeyData.data, sankeyData.layout, {
            responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
        });
    });
</script>
{% endif %}
{% endblock %}
